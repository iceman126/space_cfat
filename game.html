<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>My first Three.js app</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
    </head>
    <body>
        <script src="threejs/three.js"></script>
        <script src="threejs/DDSLoader.js"></script>
        <script src="threejs/MTLLoader.js"></script>
        <script src="threejs/OBJMTLLoader.js"></script>
        <script>
            /* some constant */
            const MOVE_SPEED = 0.08;
            const WINDOW_WIDTH = 600;
            const WINDOW_HEIGHT = 900;
            const X_LEFT_BORDER = -2;
            const X_RIGHT_BORDER = 2;
            var keyPressed = {};

            /* three.js environment */
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera( 75, WINDOW_WIDTH / WINDOW_HEIGHT, 0.1, 1000 );
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize( WINDOW_WIDTH, WINDOW_HEIGHT );
            document.body.appendChild( renderer.domElement );

            var light = new THREE.AmbientLight( 0xFFFFFF ); // soft white light
            scene.add( light );


            /* system variable */
            var keyPressed = {};
            
            /* game objects */
            function Shot(bullet1, bullet2) {
                this.bullet1 = bullet1;
                this.bullet2 = bullet2;
            }

            var our_craft;
            var bullet
            var enemy_prototype;
            var shots = [];                     // save all the bullets
            var enemy_crafts = [];
            init_bullet();
            var loader = new THREE.OBJMTLLoader();
            load_crafts();                      // <- main() is called in this function

            
            function main() {
                /* add event listener */
                /*
                document.addEventListener('keydown', function(e) { keyPressed[e.which] = true; e.preventDefault(); console.log(e.which)}, false);
                document.addEventListener('keyup', function(e) { keyPressed[e.which] = false; e.preventDefault(); }, false);

                if (keyPressed[38] == true) {
                    console.log('up');
                    our_craft.position.y += MOVE_SPEED;
                }
                if (keyPressed[40] == true) our_craft.position.y -= MOVE_SPEED;
                if (keyPressed[37] == true) our_craft.position.x -= MOVE_SPEED;
                if (keyPressed[39] == true) our_craft.position.x += MOVE_SPEED;
                if (keyPressed[32] == true) console.log('fire!!');
                */
                
                document.addEventListener('keydown', function(e) {
                    var keycode = e.which;
                        // up
                        if (keycode == 38) {
                            our_craft.position.y += MOVE_SPEED;
                        }
                        // down
                        if (keycode == 40) {
                            our_craft.position.y -= MOVE_SPEED;
                        }
                        if (our_craft.position.x >= -2) {
                            // left
                            if (keycode == 37) {
                                our_craft.position.x -= MOVE_SPEED;
                            }
                        }
                        if (our_craft.position.x <= 2) {
                            // right
                            if (keycode == 39) {
                                our_craft.position.x += MOVE_SPEED;
                            }
                        }

                    // spacebar - fire
                    if (keycode == 32) {
                        console.log('fire!!');
                        var bullet1 = bullet.clone(), bullet2 = bullet.clone();
                        bullet1.position.x = our_craft.position.x - 0.15;
                        bullet1.position.y = our_craft.position.y + 0.3;
                        bullet2.position.x = our_craft.position.x + 0.15;
                        bullet2.position.y = our_craft.position.y + 0.3;
                        var shot = new Shot(bullet1, bullet2);
                        shots.push(shot);
                        console.log(shots);
                        add_shot_to_scene(shots[shots.length - 1]);
                    }
                    e.preventDefault();
                });

                render();
            }

            /* render */

            camera.position.z = 5;

            /* bullet functions */
            function init_bullet() {
                var geometry = new THREE.CylinderGeometry(0.02, 0.02, 0.3, 32);
                var material = new THREE.MeshBasicMaterial( {color: 0xff0000} );
                bullet = new THREE.Mesh( geometry, material );
            }

            function load_crafts() {
                load_our_craft();
            }

            function load_our_craft() {
                loader.load('model/FP/F-4E_Phantom_II.obj', 'model/FP/F-4E_Phantom_II.mtl',
                    function (object) {
                        our_craft = object;
                        our_craft.scale.set(0.06, 0.06, 0.06);
                        our_craft.position.y = -1.5;
                        scene.add(our_craft);
                        load_enemy_prototype();
                });
            }

            function load_enemy_prototype() {
                loader.load('model/star-wars-vader-tie-fighter-obj/star-wars-vader-tie-fighter.obj', 'model/star-wars-vader-tie-fighter-obj/star-wars-vader-tie-fighter.mtl',
                    function (object) {
                        enemy_prototype = object;
                        enemy_prototype.scale.set(0.015, 0.015, 0.015);
                        enemy_prototype.rotation.x = Math.PI / 2;
                        scene.add(enemy_prototype);
                        main();
                });
            }

            function add_shot_to_scene(shot) {
                scene.add(shot.bullet1);
                scene.add(shot.bullet2);
            }

            function render() {
                collision_detection();
                update_game();
                requestAnimationFrame( render );
                renderer.render( scene, camera );
            }

            function collision_detection() {
                var rays = [
                    new THREE.Vector3(1, -1, 0),
                    new THREE.Vector3(1, 0, 0),
                    new THREE.Vector3(1, 1, 0),
                    new THREE.Vector3(0, 1, 0),
                    new THREE.Vector3(0, -1, 0),
                    new THREE.Vector3(-1, -1, 0),
                    new THREE.Vector3(-1, 0, 0),
                    new THREE.Vector3(-1, 1, 0),
                ];

                var caster = new THREE.Raycaster();

                for (var i = 0; i < rays.length; i++) {
                    caster.set(enemy_prototype.position, rays[i]);
                    var collisions = caster.intersectObjects(scene.children);
                    if (collisions.length > 0) {
                        console.log('hit!!!');
                        enemy_prototype.visible = false;
                    }
                }
            }

            function update_our_shots() {
                /* update bullet */
                var arr_len = shots.length;

                // remove out of bound
                for (var i = arr_len - 1; i >= 0; i--) {
                    if (shots[i].bullet1.position.y > 6) {
                        scene.remove(shots[i].bullet1);
                        scene.remove(shots[i].bullet2);
                        shots.splice(i, 1);
                    }
                }

                arr_len = shots.length;
                for (var i = 0; i < arr_len; i++) {
                    shots[i].bullet1.position.y += MOVE_SPEED;
                    shots[i].bullet2.position.y += MOVE_SPEED;
                }
            }

            function update_game() {
                update_our_shots();
            }

        </script>
    </body>
</html>