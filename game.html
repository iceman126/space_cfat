<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Space Craft</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
            #instruction {
                position: absolute;
                top: 0px;
                left: 0px;
                color: white;
            }
        </style>
    </head>
    <body>
        <script src="threejs/three.js"></script>
        <script src="threejs/DDSLoader.js"></script>
        <script src="threejs/MTLLoader.js"></script>
        <script src="threejs/OBJMTLLoader.js"></script>
        <script>
            /* some constant */
            const MOVE_SPEED = 0.8;
            const WINDOW_WIDTH = 600;
            const WINDOW_HEIGHT = 900;
            const X_LEFT_BORDER = -20;
            const X_RIGHT_BORDER = 20;
            const Y_TOP_BORDER = 38;
            const Y_BOTTOM_BORDER = -38;
            var keyPressed = {};

            /* three.js environment */
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera( 75, WINDOW_WIDTH / WINDOW_HEIGHT, 0.1, 1000 );
            var renderer = new THREE.WebGLRenderer();
            var bgImage = THREE.ImageUtils.loadTexture( 'bg/1837314.jpg' );
            var bg = new THREE.Mesh(new THREE.PlaneGeometry(192, 108, 16, 16), new THREE.MeshBasicMaterial({map: bgImage}));
            bg.rotation.z = Math.PI / 2;
            bg.position.z = -10;
            scene.add(bg);
            renderer.setSize( WINDOW_WIDTH, WINDOW_HEIGHT );
            document.body.appendChild( renderer.domElement );

            var light = new THREE.AmbientLight( 0xFFFFFF ); // soft white light
            scene.add( light );


            /* system variable */
            var keyPressed = {};
            
            /* game objects */
            function Shot(bullet1, bullet2) {
                this.bullet1 = bullet1;
                this.bullet2 = bullet2;
            }

            /* player's */
            var player_craft;
            var player_shots = [];
            var player_bullet;

            /* enemies' */
            var enemy_prototype;
            var enemies = [];
            var enemy_shots = [];
            var enemies_move = [];

            /* system's */
            var temp1 = {}, temp2 = {};

            start();

            function start() {
                /* load models */
                var manager = create_loader_manager();
                load_model(temp1, manager, 'model/star-wars-arc-170-pbr-obj/star-wars-arc-170-pbr.obj', 'model/star-wars-arc-170-pbr-obj/star-wars-arc-170-pbr.mtl', 0.3, -Math.PI / 2);
                load_model(temp2, manager, 'model/star-wars-vader-tie-fighter-obj/star-wars-vader-tie-fighter.obj', 'model/star-wars-vader-tie-fighter-obj/star-wars-vader-tie-fighter.mtl', 0.15, Math.PI / 2);

                /* initial bullets */
                init_player_bullet();
            }

            function load_model(target, manager, model_path, mat_path, scale, rotation) {
                var loader = new THREE.OBJMTLLoader(manager);
                loader.load(model_path, mat_path,
                    function (object) {
                        target.craft = object;
                        target.craft.scale.set(scale, scale, scale);
                        target.craft.rotation.x = rotation;
                });
            }

            function set_position(target, x, y) {
                target.position.x = x;
                target.position.y = y;
            }

            function create_loader_manager() {
                var manager = new THREE.LoadingManager();
                manager.onProgress = function ( item, loaded, total ) {
                    console.log( item, loaded, total );
                };
                manager.onLoad = function() {
                    player_craft = temp1.craft;
                    enemy_prototype = temp2.craft;
                    set_position(player_craft, 0, -15);
                    scene.add(player_craft);
                    main();
                };
                return manager
            }
            
            function main() {
                document.addEventListener('keydown', keydown_handler);
                document.addEventListener('keyup', keyup_handler);
                set_wave(1);
                render();
            }

            /* render */

            camera.position.z = 50;

            /* bullet functions */
            function init_player_bullet() {
                var geometry = new THREE.CylinderGeometry(0.2, 0.2, 3, 32);
                var material = new THREE.MeshBasicMaterial( {color: 0xff0000} );
                player_bullet = new THREE.Mesh( geometry, material );
            }

            function load_crafts() {
                load_our_craft();
            }

            function keyup_handler(e) {
                var keycode = e.which;
                keyPressed[keycode] = false;
            }

            function keydown_handler(e) {
                var keycode = e.which;
                keyPressed[keycode] = true;
                e.preventDefault();
            }
          
            function add_shot_to_scene(shot) {
                scene.add(shot.bullet1);
                scene.add(shot.bullet2);
            }

            function render() {
                collision_detection();
                update_game();
                bg.position.y -= 0.015
                requestAnimationFrame( render );
                renderer.render( scene, camera );
            }

            function collision_detection() {
                var rays = [
                    /*
                    new THREE.Vector3(1, -1, 0),
                    new THREE.Vector3(1, 0, 0),
                    new THREE.Vector3(1, 1, 0),
                    new THREE.Vector3(0, 1, 0),
                    new THREE.Vector3(0, -1, 0),
                    new THREE.Vector3(-1, -1, 0),
                    new THREE.Vector3(-1, 0, 0),
                    new THREE.Vector3(-1, 1, 0),
                    */
                    new THREE.Vector3(1, -1, 0),
                    new THREE.Vector3(0, -1, 0),
                    new THREE.Vector3(-1, -1, 0),
                ];

                var caster = new THREE.Raycaster();

                // console.log(enemy_prototype.position);

                var enemy_count = enemies.length;
                var player_shots_count = player_shots.length;
                for (var i = enemy_count - 1; i >= 0; i--) {
                    for (var j = 0; j < rays.length; j++) {
                        caster.set(enemies[i].position, rays[j]);
                        //for (var k = 0; k < player_shots_count; k++) {
                            var collisions = caster.intersectObjects(scene.children);
                            //var collisions = caster.intersectObjects(player_shots[k].bullet1);
                            //collisions += caster.intersectObjects(player_shots[k].bullet2);
                            if (collisions.length > 0) {
                                console.log(collisions);
                                enemies[i].visible = false;
                                scene.remove(enemies[i]);
                                enemies.splice(i, 1);
                                break;
                            }
                        //}
                    }
                }
            }

            function update_our_shots() {
                /* update bullet */
                var arr_len = player_shots.length;

                // remove out of bound
                for (var i = arr_len - 1; i >= 0; i--) {
                    if (player_shots[i].bullet1.position.y > Y_TOP_BORDER) {
                        scene.remove(player_shots[i].bullet1);
                        scene.remove(player_shots[i].bullet2);
                        player_shots.splice(i, 1);
                    }
                }

                arr_len = player_shots.length;
                for (var i = 0; i < arr_len; i++) {
                    player_shots[i].bullet1.position.y += MOVE_SPEED;
                    player_shots[i].bullet2.position.y += MOVE_SPEED;
                }
            }

            function update_game() {
                update_player_craft();
                update_our_shots();
                update_enemies();
                if (enemies.length == 0) {
                    set_wave(2);
                }
            }

            // set wave enemy
            function set_wave(index) {
                if (index == 1) {
                    var enemy_count = 10;
                    for (var i = 0; i < 10; i++) {
                        var temp_enemy = enemy_prototype.clone();
                        var temp_dir = [0, -0.25, 0];
                        temp_enemy.position.x = -15 + 5 * (i % 5);
                        temp_enemy.position.y = Y_TOP_BORDER + 4 - 5 * Math.floor(i / 5);
                        enemies.push(temp_enemy);
                        enemies_move.push(temp_dir);
                        scene.add(enemies[enemies.length - 1]);
                    }
                }
                if (index == 2) {
                    var enemy_count = 10;
                    for (var i = 0; i < 10; i++) {
                        var temp_enemy = enemy_prototype.clone();
                        var temp_dir = [0, -0.25, 0];
                        temp_enemy.position.x = -15 + 5 * (i % 5);
                        temp_enemy.position.y = Y_TOP_BORDER + 4 - 5 * Math.floor(i / 5);
                        enemies.push(temp_enemy);
                        enemies_move.push(temp_dir);
                        scene.add(enemies[enemies.length - 1]);
                    }
                }
            }

            function update_enemies() {
                var enemy_count = enemies.length;
                for (var i = 0; i < enemy_count; i++) {
                    enemies[i].position.x += enemies_move[i][0];
                    enemies[i].position.y += enemies_move[i][1];
                }

                for (var i = enemy_count - 1; i >= 0; i--) {
                    if (enemies[i].position.x > X_RIGHT_BORDER || enemies[i].position.x < X_LEFT_BORDER || enemies[i].position.y < Y_BOTTOM_BORDER) {
                        enemies[i].visible = false;
                        scene.remove(enemies[i]);
                        enemies.splice(i, 1);                        
                    }
                }
            }

            function update_player_craft() {
                // up
                if (keyPressed[38] == true) {
                    player_craft.position.y += MOVE_SPEED;
                }
                // down
                if (keyPressed[40] == true) {
                    player_craft.position.y -= MOVE_SPEED;
                }
                if (keyPressed[37] == true && player_craft.position.x >= X_LEFT_BORDER) {
                    player_craft.position.x -= MOVE_SPEED;
                }
                if (keyPressed[39] == true && player_craft.position.x <= X_RIGHT_BORDER) {
                    player_craft.position.x += MOVE_SPEED;
                }

                // spacebar - fire
                if (keyPressed[32] == true) {
                    var bullet1 = player_bullet.clone(), bullet2 = player_bullet.clone();
                    bullet1.position.x = player_craft.position.x - 1.5;
                    bullet1.position.y = player_craft.position.y + 3;
                    bullet2.position.x = player_craft.position.x + 1.5;
                    bullet2.position.y = player_craft.position.y + 3;
                    var shot = new Shot(bullet1, bullet2);
                    player_shots.push(shot);
                    console.log(player_shots);
                    add_shot_to_scene(player_shots[player_shots.length - 1]);
                }
            }
        </script>
        <div id="instruction">
        CONTROL:<br />
        <b>Move:</b> Arrow Keys<br />
        <b>Shoot:</b> SpaceBar<br />
        </div>
    </body>
</html>